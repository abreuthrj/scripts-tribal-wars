const _customscript_watcher_priorities={queue:[],balanced:[],unbalanced:[]};var _customscript_watcher_nextBuildingBuffer=null,_customscript_watcher_buildingsBuffer=null,_customscript_watcher_schedulerON=!1;const _customscript_watcher_timeleft=()=>{try{return document.querySelector("span[data-endtime]").innerHTML.split(":").map((t=>parseInt(t)))}catch(t){return[-1,-1,-1]}},_customscript_watcher=()=>{const[t,e,c]=_customscript_watcher_timeleft();0==t&&e<3&&document.querySelector("td.lit-item a.order_feature.btn.btn-btr.btn-instant-free").click(),setTimeout((()=>{_customscript_watcher_schedulerON&&_customscript_watcher_runScheduler(),_customscript_watcher_updateDOM(),_customscript_watcher()}),1e3)},_customscript_watcher_buildDOM=()=>{const t=document.createElement("div"),e=document.createElement("span"),c=document.createElement("span");t.style="position:fixed;bottom:0;right:0;padding:.5em;background-color:#333333a0;color:white;z-index:100000",e.style="display:block;margin-bottom:1rem;",c.style="display:block;",t.id="_customscript_watcher_displayDOM",e.id="_customscript_watcher_displayDynamicDOM",c.id="_customscript_watcher_displayStaticDOM",document.body.appendChild(t),t.appendChild(e),t.appendChild(c);let r=window.localStorage.getItem("_customscript_watcher_queue");if(r)try{_customscript_watcher_priorities.queue=JSON.parse(r)}catch(t){console.log(t)}},_customscript_watcher_updateDOM=()=>{const t=document.querySelector("#_customscript_watcher_displayDynamicDOM"),e=document.querySelector("#_customscript_watcher_displayStaticDOM"),c={..._customscript_watcher_buildInfoList()},r=_customscript_watcher_getBuildingsList();if(t.innerHTML=c.title,delete c.title,Object.keys(c).forEach((e=>{c[e]&&(t.innerHTML=`${t.innerHTML}<br>${e}: ${c[e]}`)})),JSON.stringify(r)!==JSON.stringify(_customscript_watcher_buildingsBuffer)){let t="";t=`\n    <select id="_customscript_watcher_selectBuildingDOM">${r.map((t=>`<option value="${t.id}">${t.name}</option>`)).join("")}</select>\n    <button id="_customscript_watcher_pushToQueueButtonDOM">ADD</button>\n    <button id="_customscript_watcher_popFromQueueButtonDOM">REM</button>\n    <br>\n    Scheduler <button id="_customscript_watcher_schedulerToggleButtonDOM">${_customscript_watcher_schedulerON?"ON":"OFF"}</button>\n    `,e.innerHTML=t;const c=document.querySelector("#_customscript_watcher_pushToQueueButtonDOM");c&&(c.removeEventListener("click",_customscript_watcher_pushToQueueOnce),c.addEventListener("click",_customscript_watcher_pushToQueueOnce));const i=document.querySelector("#_customscript_watcher_popFromQueueButtonDOM");i&&(i.removeEventListener("click",_customscript_watcher_popFromQueueOnce),i.addEventListener("click",_customscript_watcher_popFromQueueOnce));const s=document.querySelector("#_customscript_watcher_schedulerToggleButtonDOM");s&&(s.onclick=_customscript_watcher_toggleSchedulerONOFF),_customscript_watcher_buildingsBuffer=r}},_customscript_watcher_buildInfoList=()=>{const t=_customscript_watcher_getMainResources(),[e,c,r]=_customscript_watcher_timeleft();return{title:"Watching",resources:Object.values(t).join(","),jump_remaining:-1==e?null:`${e<10?`0${e}`:e}:${c-3<10?"0"+(c-3):c-3}:${r<10?`0${r}`:r}`,next_building:_customscript_watcher_nextBuildingBuffer?.name,queued:_customscript_watcher_priorities.queue.length>0?`<table>${_customscript_watcher_priorities.queue.map((t=>`<tr><td>${t}</td></tr>`)).join("")}</table>`:null}},_customscript_watcher_getBuildingsList=()=>[...document.querySelectorAll("#buildings tr:not(:first-child)")].filter((t=>t.querySelectorAll("td").length>2)).map((t=>{let e=t.querySelector("td:first-child img:first-child").getAttribute("data-title"),c=t.id,r=-1;try{r=parseInt(t.querySelector("td:first-child span:last-child").innerHTML.match(/([0-9]+)/)[0])}catch(t){console.log(t)}let i={wood:parseInt(t.querySelector("td.cost_wood").getAttribute("data-cost")),stone:parseInt(t.querySelector("td.cost_stone").getAttribute("data-cost")),iron:parseInt(t.querySelector("td.cost_iron").getAttribute("data-cost"))},s=1e8;try{s=t.querySelector(".cost_iron~td").innerHTML.match(/([0-9]+):([0-9]+):([0-9]+)/)[0].split(":").map(((t,e)=>parseInt(t)*(0==e?3600:1==e?60:1))).reduce(((t,e)=>t+e),0)}catch(t){console.log(t)}return{name:e,id:c,level:r,resources:i,duration:s}})),_customscript_watcher_getNextBuilding=()=>{const t=_customscript_watcher_getBuildingsList(),e=_customscript_watcher_getMainResources(),c=t.filter((t=>t.resources.wood<=e.wood&&t.resources.stone<=e.stone&&t.resources.iron<=e.iron));let r=[];if(_customscript_watcher_priorities.queue.length>0){r=c.filter((t=>_customscript_watcher_priorities.queue.includes(t.id)));for(let[t,e]of _customscript_watcher_priorities.queue.entries()){let c=r.find((t=>t.id==e));if(c)return _customscript_watcher_priorities.queue.splice(t,1),c}}if(_customscript_watcher_priorities.balanced.length>0)return r=c.filter((t=>_customscript_watcher_priorities.balanced.includes(t.id))).sort(((t,e)=>t.level<e.level?-1:1)),r[0];if(_customscript_watcher_priorities.unbalanced.length>0){r=c.filter((t=>_customscript_watcher_priorities.unbalanced.includes(t.id)));let t=_customscript_watcher_priorities.unbalanced.shift();return _customscript_watcher_priorities.unbalanced.push(t),t}return c.sort(((t,e)=>t.duration<e.duration?-1:1))[0]},_customscript_watcher_getMainResources=()=>({wood:parseInt(document.querySelector("#wood").innerHTML),stone:parseInt(document.querySelector("#stone").innerHTML),iron:parseInt(document.querySelector("#iron").innerHTML)}),_customscript_watcher_pushToQueueOnce=()=>{console.log("ADDING ",document.querySelector("#_customscript_watcher_selectBuildingDOM").value),_customscript_watcher_priorities.queue.push(document.querySelector("#_customscript_watcher_selectBuildingDOM").value),_customscript_watcher_cacheQueue(),_customscript_watcher_updateDOM()},_customscript_watcher_popFromQueueOnce=()=>{console.log("REMOVING ",_customscript_watcher_priorities.queue[0]),_customscript_watcher_priorities.queue.shift(),_customscript_watcher_cacheQueue(),_customscript_watcher_updateDOM()},_customscript_watcher_runScheduler=()=>{if(_customscript_watcher_nextBuildingBuffer||(_customscript_watcher_nextBuildingBuffer=_customscript_watcher_getNextBuilding()),!_customscript_watcher_nextBuildingBuffer||4==document.querySelectorAll("#buildqueue tr").length)return;const t=document.querySelector(`#${_customscript_watcher_nextBuildingBuffer.id} a.btn.btn-build`);t&&(_customscript_watcher_nextBuildingBuffer=null,_customscript_watcher_cacheQueue(),t.click())},_customscript_watcher_toggleSchedulerONOFF=()=>{_customscript_watcher_schedulerON=!_customscript_watcher_schedulerON,_customscript_watcher_nextBuildingBuffer=null;document.querySelector("#_customscript_watcher_schedulerToggleButtonDOM").innerHTML=_customscript_watcher_schedulerON?"ON":"OFF"},_customscript_watcher_cacheQueue=()=>{let t=[..._customscript_watcher_priorities.queue];_customscript_watcher_nextBuildingBuffer&&(t=[_customscript_watcher_nextBuildingBuffer.id,...t]),window.localStorage.setItem("_customscript_watcher_queue",JSON.stringify())};location.search.includes("screen=main")&&(_customscript_watcher_buildDOM(),_customscript_watcher());
